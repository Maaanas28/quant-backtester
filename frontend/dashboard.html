<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - NeuroQuant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .mobile-menu {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
        .mobile-menu.active {
            max-height: 500px;
        }
    </style>
</head>
<body class="bg-black text-white min-h-screen">
    
    <header class="border-b border-neutral-900 bg-black/50 backdrop-blur-xl sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 py-4">
            <div class="flex items-center justify-between">
                <h1 class="text-lg sm:text-xl font-semibold">NeuroQuant</h1>
                
                <!-- Desktop Navigation -->
                <nav class="hidden md:flex items-center space-x-6 text-sm">
                    <a href="/" class="text-neutral-400 hover:text-white transition">Home</a>
                    <a href="/dashboard" class="text-white font-medium">Dashboard</a>
                    <a href="/strategies" class="text-neutral-400 hover:text-white transition">Strategies</a>
                    <a href="/backtest" class="text-neutral-400 hover:text-white transition">Backtest</a>
                    <a href="/compare" class="text-neutral-400 hover:text-white transition">Compare</a>
                    <a href="/lab" class="text-neutral-400 hover:text-white transition">Lab</a>
                </nav>

                <div class="flex items-center space-x-3">
                    <div class="flex items-center space-x-2 px-3 py-1.5 bg-neutral-900 rounded-lg">
                        <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                        <span class="text-xs font-mono text-neutral-400">LIVE</span>
                    </div>

                    <!-- Mobile menu button -->
                    <button id="mobileMenuBtn" class="md:hidden p-2 rounded-lg hover:bg-neutral-900 transition">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Mobile Navigation -->
            <nav id="mobileMenu" class="mobile-menu md:hidden mt-4 space-y-2">
                <a href="/" class="block px-4 py-2 text-neutral-400 hover:text-white hover:bg-neutral-900 rounded-lg transition">Home</a>
                <a href="/dashboard" class="block px-4 py-2 text-white font-medium bg-neutral-900 rounded-lg">Dashboard</a>
                <a href="/strategies" class="block px-4 py-2 text-neutral-400 hover:text-white hover:bg-neutral-900 rounded-lg transition">Strategies</a>
                <a href="/backtest" class="block px-4 py-2 text-neutral-400 hover:text-white hover:bg-neutral-900 rounded-lg transition">Backtest</a>
                <a href="/compare" class="block px-4 py-2 text-neutral-400 hover:text-white hover:bg-neutral-900 rounded-lg transition">Compare</a>
                <a href="/lab" class="block px-4 py-2 text-neutral-400 hover:text-white hover:bg-neutral-900 rounded-lg transition">Lab</a>
            </nav>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 py-6 sm:py-8">
        
        <div class="mb-6 sm:mb-8">
            <h2 class="text-2xl sm:text-3xl font-bold mb-2">Performance Dashboard</h2>
            <p class="text-sm sm:text-base text-neutral-500">Real-time portfolio analytics and backtest history</p>
        </div>

        <div class="grid grid-cols-2 md:grid-cols-4 gap-3 sm:gap-4 mb-6 sm:mb-8">
            <div class="bg-neutral-950 border border-neutral-900 rounded-xl p-4 sm:p-6">
                <div class="text-xs font-mono text-neutral-500 mb-2">TOTAL BACKTESTS</div>
                <div class="text-lg sm:text-2xl font-semibold font-mono mb-1" id="totalBacktests">0</div>
                <div class="text-xs text-neutral-500">Historical runs</div>
            </div>
            <div class="bg-neutral-950 border border-neutral-900 rounded-xl p-4 sm:p-6">
                <div class="text-xs font-mono text-neutral-500 mb-2">AVG RETURN</div>
                <div class="text-lg sm:text-2xl font-semibold font-mono mb-1" id="avgReturn">0.00%</div>
                <div class="text-xs text-neutral-500" id="returnStatus">—</div>
            </div>
            <div class="bg-neutral-950 border border-neutral-900 rounded-xl p-4 sm:p-6">
                <div class="text-xs font-mono text-neutral-500 mb-2">AVG SHARPE</div>
                <div class="text-lg sm:text-2xl font-semibold font-mono mb-1" id="avgSharpe">0.00</div>
                <div class="text-xs text-neutral-500">Risk-adjusted</div>
            </div>
            <div class="bg-neutral-950 border border-neutral-900 rounded-xl p-4 sm:p-6">
                <div class="text-xs font-mono text-neutral-500 mb-2">TOTAL TRADES</div>
                <div class="text-lg sm:text-2xl font-semibold font-mono mb-1" id="totalTrades">0</div>
                <div class="text-xs text-neutral-500">All backtests</div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 sm:gap-6 mb-6 sm:mb-8">
            <div class="bg-neutral-950 border border-neutral-900 rounded-xl p-4 sm:p-6">
                <h3 class="text-xs sm:text-sm font-mono text-neutral-500 mb-4">RECENT BACKTESTS</h3>
                <div id="recentBacktests" class="space-y-3">
                    <div class="text-center py-8 text-sm text-neutral-500">Loading...</div>
                </div>
            </div>

            <div class="bg-neutral-950 border border-neutral-900 rounded-xl p-4 sm:p-6">
                <h3 class="text-xs sm:text-sm font-mono text-neutral-500 mb-4">PERFORMANCE DISTRIBUTION</h3>
                <div class="h-48 sm:h-64 relative">
                    <canvas id="performanceChart"></canvas>
                </div>
            </div>
        </div>

        <div class="bg-neutral-950 border border-neutral-900 rounded-xl p-4 sm:p-6">
            <h3 class="text-xs sm:text-sm font-mono text-neutral-500 mb-4">BACKTEST HISTORY</h3>
            <div class="overflow-x-auto -mx-4 sm:mx-0">
                <table class="w-full text-xs sm:text-sm min-w-[700px]">
                    <thead>
                        <tr class="border-b border-neutral-800">
                            <th class="text-left py-2 px-2 sm:px-0 text-neutral-400">Date</th>
                            <th class="text-left py-2 px-2 sm:px-0 text-neutral-400">Symbol</th>
                            <th class="text-left py-2 px-2 sm:px-0 text-neutral-400">Strategy</th>
                            <th class="text-right py-2 px-2 sm:px-0 text-neutral-400">Return</th>
                            <th class="text-right py-2 px-2 sm:px-0 text-neutral-400">Sharpe</th>
                            <th class="text-right py-2 px-2 sm:px-0 text-neutral-400">Trades</th>
                            <th class="text-right py-2 px-2 sm:px-0 text-neutral-400">Final Value</th>
                        </tr>
                    </thead>
                    <tbody id="historyBody">
                        <tr><td colspan="7" class="py-4 text-center text-xs sm:text-sm text-neutral-500">Loading...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <footer class="border-t border-neutral-900 mt-16 py-8">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 text-center text-sm text-neutral-500">
            <p>NeuroQuant © 2025 • Algorithmic Trading Platform</p>
        </div>
    </footer>

    <script>
    // Mobile menu toggle
    document.getElementById('mobileMenuBtn').addEventListener('click', function() {
        document.getElementById('mobileMenu').classList.toggle('active');
    });

    // Auto-detect API base URL (works for both local and deployed)
    const API_BASE = window.location.hostname === 'localhost' 
        ? 'http://localhost:8000/api' 
        : `${window.location.origin}/api`;
    let performanceChart = null;

    async function loadDashboardData() {
        try {
            const response = await fetch(API_BASE + '/backtest_runs');
            if (!response.ok) throw new Error('Failed to load data');
            
            const runs = await response.json();
            
            if (runs.length === 0) {
                document.getElementById('recentBacktests').innerHTML = '<div class="text-center py-8 text-neutral-500">No backtests yet<br><a href="/backtest" class="text-blue-500 hover:text-blue-400 text-sm">Run your first backtest →</a></div>';
                document.getElementById('historyBody').innerHTML = '<tr><td colspan="7" class="py-4 text-center text-neutral-500">No backtest history</td></tr>';
                return;
            }

            updateSummaryMetrics(runs);
            updateRecentBacktests(runs.slice(0, 5));
            updateHistoryTable(runs);
            updatePerformanceChart(runs);
        } catch (error) {
            console.error('Failed to load dashboard data:', error);
            document.getElementById('recentBacktests').innerHTML = '<div class="text-center py-8 text-red-500">Failed to load data</div>';
        }
    }

    function updateSummaryMetrics(runs) {
        document.getElementById('totalBacktests').textContent = runs.length;
        
        const avgReturn = runs.reduce((sum, r) => sum + r.agent_return, 0) / runs.length;
        const avgReturnEl = document.getElementById('avgReturn');
        avgReturnEl.textContent = avgReturn.toFixed(2) + '%';
        avgReturnEl.className = avgReturn >= 0 ? 'text-2xl font-semibold font-mono mb-1 text-green-500' : 'text-2xl font-semibold font-mono mb-1 text-red-500';
        
        document.getElementById('returnStatus').textContent = avgReturn >= 0 ? 'Profitable' : 'Loss';
        document.getElementById('returnStatus').className = avgReturn >= 0 ? 'text-xs text-green-500' : 'text-xs text-red-500';

        const validSharpes = runs.filter(r => r.sharpe_ratio !== null && !isNaN(r.sharpe_ratio));
        const avgSharpe = validSharpes.length > 0 
            ? validSharpes.reduce((sum, r) => sum + (r.sharpe_ratio || 0), 0) / validSharpes.length 
            : 0;
        document.getElementById('avgSharpe').textContent = avgSharpe.toFixed(2);
        
        const totalTrades = runs.reduce((sum, r) => sum + (r.total_trades || 0), 0);
        document.getElementById('totalTrades').textContent = totalTrades;
    }

    function updateRecentBacktests(recentRuns) {
        const container = document.getElementById('recentBacktests');
        container.innerHTML = recentRuns.map(run => {
            const returnClass = run.agent_return >= 0 ? 'text-green-500' : 'text-red-500';
            const date = new Date(run.timestamp).toLocaleDateString();
            
            return '<div class="flex items-center justify-between py-2 border-b border-neutral-800"><div><div class="font-medium">' + run.symbol + ' - ' + (run.agent_name || 'Unknown') + '</div><div class="text-xs text-neutral-500">' + date + '</div></div><div class="text-right"><div class="font-mono ' + returnClass + '">' + run.agent_return.toFixed(2) + '%</div><div class="text-xs text-neutral-500">' + (run.total_trades || 0) + ' trades</div></div></div>';
        }).join('');
    }

    function updateHistoryTable(runs) {
        const tbody = document.getElementById('historyBody');
        tbody.innerHTML = runs.map(run => {
            const returnClass = run.agent_return >= 0 ? 'text-green-500' : 'text-red-500';
            const date = new Date(run.timestamp).toLocaleDateString();
            
            return '<tr class="border-b border-neutral-900"><td class="py-2">' + date + '</td><td class="py-2">' + run.symbol + '</td><td class="py-2">' + (run.agent_name || 'Unknown') + '</td><td class="py-2 text-right ' + returnClass + '">' + run.agent_return.toFixed(2) + '%</td><td class="py-2 text-right">' + (run.sharpe_ratio || 0).toFixed(2) + '</td><td class="py-2 text-right">' + (run.total_trades || 0) + '</td><td class="py-2 text-right">$' + (run.final_value || 0).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + '</td></tr>';
        }).join('');
    }

    function updatePerformanceChart(runs) {
        const ctx = document.getElementById('performanceChart').getContext('2d');
        
        if (performanceChart) performanceChart.destroy();

        const returns = runs.map(r => r.agent_return);
        const positive = returns.filter(r => r >= 0).length;
        const negative = returns.filter(r => r < 0).length;

        performanceChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Profitable', 'Loss'],
                datasets: [{
                    data: [positive, negative],
                    backgroundColor: ['rgb(34, 197, 94)', 'rgb(239, 68, 68)'],
                    borderColor: 'rgb(10, 10, 10)',
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            color: 'rgb(163, 163, 163)',
                            padding: 15
                        }
                    }
                }
            }
        });
    }

    loadDashboardData();
    setInterval(loadDashboardData, 30000);
    </script>

</body>
</html>
